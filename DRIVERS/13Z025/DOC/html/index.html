<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - Linux UART Driver for 16Z025 FPGA unit - Linux native driver for MEN Chameleon FPGA driver/device registration.</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;">
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">Linux UART Driver for 16Z025 FPGA unit &nbsp; </h1>
	<h3>Linux native driver for MEN Chameleon FPGA driver/device registration.</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindexHL" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>Linux native driver for MEN Chameleon FPGA driver/device registration. </h1>
<p>
The men_lx_frodo Linux kernel module is the stub driver for registering MEN FPGA Uarts to the kernels serial core driver. The Units supported are 16Z025, 16Z057 and 16Z125. These UARTS are compatible to the classic 16550 UARTs.<p>
<br>
 <h2><a name="installation"></a>
Driver Build and Installation</h2>
The men_lx_frodo driver is primarily intended to be built together with the MDIS system Package.<h3><a name="installation_mdis"></a>
Build using MEN MDIS framework</h3>
When using the ElinOS and MEN MDIS environments, the driver can be built and installed just by adding the MDIS makefile <br>
<p>
$(MEN_LIN_DIR)/DRIVERS/CHAMELEON/driver.mak <br>
<p>
to the $(ELINOS_PROJECT)/src/mdis/Makefile under the ALL_NATIVE_DRIVERS entry. The drivers object file is installed properly into the ElinOS environment (path: $(ELINOS_PROJECT)/kernel.rootfs/lib/modules/$(LINUX_VERSION)/misc). <br>
<p>
If you are using the MEN MDIS Configuration Wizard (MDISWIZ) the driver is automatically built if a device is configured which needs it.<p>
<br>
 <h2><a name="parameter"></a>
Parameter</h2>
The FPGA UART Driver takes 2 Parameters:<h3><a name="baud_base"></a>
System Clock setting</h3>
On the EM01 the base_baud clock is slightly different: baud_base=4142857 ( = 132,571MHz/32 ) due to different needed clock frequencies for other IP cores in these CPUs (framebuffer etc.)<p>
When passing an other than the standard Clock, pass it on baud_base=value If the Value is omitted, the standard UART clock (33333333) is used. <br>
<h3><a name="units"></a>
Necessary Clock setting for special UART Units</h3>
Due to certain previous Developments there are several different UART units that may be built in the FPGA for which this driver is used. The previous explanations match for the 16Z025 and 16Z125 Units, while the 16Z057 Unit is a special case: It internally just accepts "classic" Divisor settings that are derived from a baud base of 115200, independent of the true PCI frequency. So, for an FPGA containing this unit the Parameter baud_base is automatically corrected to baud_base=115200, this is reported in the kernel messages (available with dmesg)<h3><a name="mode"></a>
physical Mode setting</h3>
When no mode parameter is passed, the default physical setting is single ended (RS232)<p>
The physical line mode can be passed as a kernel or module parameter:<p>
Module parameter (Kernel 2.4): mode="mode mode mode mode" <br>
 Module parameter (Kernel 2.6): mode=mode,mode,mode,mode <br>
<p>
Where each  specifies the physical line mode of the nth frodo IF and can be:<ul>
<li>se - single ended (RS232), the default</li><li>df_fdx - differential, full duplex</li><li>df_hdxe - differential, half duplex, with echo</li><li>df_hdx - differential, half duplex, echo suppressed</li></ul>
<p>
Example: for usage of F210 UARTs add a line to /etc/inittab like this: modprobe men_lx_frodo mode="se,se,se,se,se" to get the additional UARTs registered.<p>
<br>
 <h2><a name="kerparinfo"></a>
Important kernelparameters and BIOS settings for x86 Boards</h2>
In the current driver Version APIC support (Advanced Peripheral Interrupt Controller) is not included so its necessary to turn the APIC off in the BIOS. The Reason is that the IRQ number of the FPGA in the Chameleon PCI Header is not equal to that used in the kernel at runtime. The following dump shows the registered Interrupt handlers when APIC is not used. Then the standard XT-PIC handles the devices at their original IRQ number from PCI Space.<p>
<div class="fragment"><pre>
	           CPU0       
		   0:     104010          XT-PIC  timer
		   2:          0          XT-PIC  cascade
		   3:       1349          XT-PIC  uhci_hcd:usb1, ehci_hcd:usb5
		   5:        665          XT-PIC  uhci_hcd:usb4, HDA Intel
		   7:         43          XT-PIC  serial 
		   9:          0          XT-PIC  acpi
		   10:          0          XT-PIC  uhci_hcd:usb3
		   11:       5323          XT-PIC  libata, uhci_hcd:usb2, eth1
		   NMI:          0 
		   LOC:     103893 
		   ERR:          0
		   MIS:          0
	</pre></div><p>
APIC support is planned for a future Release of the MDIS System package.<p>
When the module is properly built and the module dependencies are generated with depmod, the Driver can be loaded via modprobe. The Driver depends on the core chameleon library which is reflected by the "Used by" field of the lsmod command:<p>
<div class="fragment"><pre>
 #&gt; lsmod
 Module                  Size  Used by
 men_lx_frodo            3520  0 
 men_lx_chameleon        5016  1 men_lx_frodo
 men_chameleon          10640  1 men_lx_chameleon
 men_oss                16112  2 men_lx_chameleon,men_chameleon
</pre></div><br>
 <h2><a name="kernelsettings"></a>
Necessary Kernel settings</h2>
Problems can occur if a FPGA contains many (&gt; 4) UARTs and the CPU itself already contains COM ports which is usually the case. Then the kernel must be configured such that the support for more than 4 UARTs is enabled. A tested Kernel Configuration example contains the section shown below in the linux/.config File:<p>
<div class="fragment"><pre>
 #
 # Serial drivers
 #
 CONFIG_SERIAL_8250=y
 CONFIG_SERIAL_8250_CONSOLE=y
 CONFIG_SERIAL_8250_NR_UARTS=10
 CONFIG_SERIAL_8250_EXTENDED=y
 CONFIG_SERIAL_8250_MANY_PORTS=y
 CONFIG_SERIAL_8250_SHARE_IRQ=y
</pre></div><p>
<br>
 <h2><a name="newpar"></a>
Specifying nr. of UARTs as kernel parameter</h2>
since late 2.6 kernels there is a more convenient method available to specify how much UARTs shall be initialized upon boot time. The kernel parameter nr_uarts lets the user specify this. It must be added e.g. in the GRUB boot loader to be passed as a kernel parameter. Since the 8250 core driver is almost always statically compiled in the used kernel, the dot notation for the module parameter has to be used: <div class="fragment"><pre>    
    8250.nr_uarts=64    
</pre></div><p>
<br>
 <h2><a name="Serial"></a>
Port Naming / Assigment under Linux</h2>
Care should be taken when using Uart devices across different HW Platforms. The device nodes assigned to the additional UARTs can vary, and might not follow the last On-Chip COM Port in a linear order. For example, If an x86 CPU contains 2 devices (/dev/ttyS0 and /dev/ttyS1) the new serial Ports are assigned as as /dev/ttyS4 until /dev/ttyS7. So, a sufficient number of Device node entries in /dev/ must exist too, the entries must look like this (Major number 4, Minors starting at 64): <div class="fragment"><pre>
 -sh-3.00# l /dev/ttyS*
 crw-rw----  1 root root 4, 64 Jan 30  2007 /dev/ttyS0
 crw-rw----  1 root root 4, 65 Jan 30  2007 /dev/ttyS1
 crw-rw----  1 root root 4, 66 Jan 30  2007 /dev/ttyS2
 crw-rw----  1 root root 4, 67 Jan 30  2007 /dev/ttyS3
 crw-r--r--  1 root root 4, 68 Aug 14 01:48 /dev/ttyS4
 crw-r--r--  1 root root 4, 69 Aug 14 01:51 /dev/ttyS5
 crw-r--r--  1 root root 4, 70 Aug 11 00:07 /dev/ttyS6
 crw-r--r--  1 root root 4, 71 Aug 14 01:49 /dev/ttyS7
 crw-r--r--  1 root root 4, 72 Aug 14 01:06 /dev/ttyS8
</pre></div><p>
See the Linux Serial-HOWTO for more info. 
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for Linux UART Driver for 16Z025 FPGA unit using <a href="http://www.doxygen.org">doxygen</a>.<br>
	Copyright &copy; 2019 <a href="http://www.men.de">MEN Mikro Elektronik GmbH</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

